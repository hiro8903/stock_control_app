<% provide(:title, "発注一覧") %>

<div class="text-center">
  <h1>発注一覧</h1>
</div>
<div>
  <%= link_to "発注登録", new_order_path, class: "btn btn-primary m-1" %>
    <% if @orders.present? %>
      <div class="row justify-content-center text-center">
        <div class="col-12">
          <table id ="fav-table" class="table">
            <thead>
              <tr>
              <th></th>
                <th scope="col"><%= Order.human_attribute_name("paint") %></th>
                <th scope="col"><%= Order.human_attribute_name("order_on") %></th>
                <th scope="col"><%= Order.human_attribute_name("desired_on") %></th>
                <th scope="col"><%= Order.human_attribute_name("quantity") %></th>
                <th scope="col"><%= Answer.human_attribute_name("scheduled_at") %></th>
                <th scope="col"><%= Answer.human_attribute_name("quantity") %></th>
                <th scope="col">Oder.answers.count</th>
                <th scope="col"><%= Order.human_attribute_name("note") %></th>
                <th scope="col"><%= Order.human_attribute_name("unit_price") %></th>
                <th scope="col"><%= Order.human_attribute_name("total_price") %></th>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col">回答登録</th>
                <th scope="col">入荷登録</th>
              </tr>
            </thead>
            <tbody>
            <% @orders.each do |order| %>
                <tr class="align-middle">
                  <td>
                    <% if (flash.present? && flash[:success] == '発注登録しました。' && @orders.last == order) || (order.answers.present? && flash.present? && flash[:success] == '回答登録しました。' && Answer.all.order(updated_at: :desc).first) == order.answers.last %>
                    <div class="alert-success d-flex align-items-center">
                      <svg width="24" height="24"><use xlink:href="#check-circle-fill"/></svg>
                    </div>
                    <% end %>
                  </td>
                  <td><%= link_to order.paint.name, order %></td>
                  <td><%= order.order_on.strftime("%Y / %m / %d") if order.order_on.present? %></td>
                  <td><%= order.desired_on.present? ? order.desired_on.strftime("%Y / %m / %d") : '成行'  %></td>
                  <td><%= order.quantity %></td>
                  <td><%= order.answers.present? ? order.answers.first.scheduled_at.strftime("%Y / %m / %d") : '-'  %></td>
                  <td><%= order.answers.present? ? order.answers.first.quantity : '-'  %></td>
                  <td><%= order.answers.count %></td>
                  <td><%= order.note.present? ? order.note : '-'  %></td>
                  <td><%= order.unit_price.present? ? order.unit_price : '-'  %></td>
                  <td><%= order.total_price.present? ? order.total_price : '-'  %></td>
                  <td><%= link_to "編集", edit_order_path(order), class: "btn btn-sm btn-success" %></td>
                  <td><%= link_to "削除", order_path(order), data: {
                    turbo_method: :delete,
                      turbo_confirm: "本当に削除しますか？"
                    }, class: "btn btn-sm btn-danger" %></td>
                  <% if orders_helper_residual(order).to_i != 0 && order.answers.count >= 1 %>
                    <td>
                      <%= link_to "登録", new_order_answer_path(order), class: "btn btn-sm btn-primary" %>/
                      <%= link_to "一覧", order_answers_path(order), class: "btn btn-sm btn-success" %>
                    </td>
                  <% elsif orders_helper_residual(order).to_i != 0 %>
                    <td><%= link_to "登録", new_order_answer_path(order), class: "btn btn-sm btn-primary" %></td>
                  <% else %>
                    <td><%= link_to "一覧", order_answers_path(order), class: "btn btn-sm btn-success" %></td>
                  <% end %>
                  <td><%= link_to "入荷", new_order_arrival_path(order), class: "btn btn-sm btn-primary" %></td>
                </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
</div>